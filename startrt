#!/bin/bash

ACTION=$1
USER=$2

checkUser() {
	if [ ! -e exclude ] ; then
		touch exclude
	fi
	EXIST=`ls /var/rutorrent/rutorrent/conf/users | grep -w $USER | wc -l`
	if [ $EXIST = '0' ] ; then
		echo "$USER - nie posiada rtorrenta"
		exit
	fi
	ISSTARTED=`pgrep -u $USER rtorrent | wc -l`
	DISKQUOTA=`repquota -u -s /home | grep $USER | awk '{print $2'}`
}

startRt() {
	for ((c=0; c<4; c++)) ; do
		checkUser
		if [ $ISSTARTED != '0' ] ; then
			echo "$USER - rtorrent jest uruchomiony"
			break
		elif [ $c = '0' ] && [ $DISKQUOTA = '+-' ] ; then
			echo "$USER - przekroczone miejsce na dysku"
			break
		elif [ $c = '0' ] ; then
			su $USER -c "screen -dmS rtorrent rtorrent"
			echo "$USER - czekam 5 sekund na potwierdzenie działania rtorrenta"
			sleep 5s
		elif [ $c = '1' ] ; then
			echo "$USER - kasuje pliki rtorrenta i sesji screen"
			rm -f /home*/$USER/.rtorrent/rpc.socket
			rm -f /home*/$USER/.rtorrent/rtorrent.lock
			# Legacy
			rm -f /home*/$USER/rtorrent/rpc.socket
			rm -f /home*/$USER/rtorrent/rtorrent.lock
			rm -f /home*/$USER/rtorrent/session/rpc.socket
			rm -f /home*/$USER/rtorrent/session/rtorrent.lock
			rm -fr /var/run/screen/S-$USER
			su $USER -c "screen -dmS rtorrent rtorrent"
			echo "$USER - czekam 5 sekund na potwierdzenie działania rtorrenta"
			sleep 5s
		elif [ $c = '2' ] ; then
			echo "$USER - Usuwam wszystkie załadowane torrenty"
			rm -f /home*/$USER/.rtorrent/*
			# Legacy
			rm -f /home*/$USER/rtorrent/session/*
			rm -f /home*/$USER/rtorrent/*
			su $USER -c "screen -dmS rtorrent rtorrent"
			echo "$USER - czekam 5 sekund na potwierdzenie działania rtorrenta"
			sleep 5s
			checkUser
		fi
	done
}

stopRt() {
	checkUser
	if [ $ISSTARTED = '0' ] ; then
		echo "$USER - rtorrent jest już zatrzymany"
	else
	 	pkill -SIGKILL -u $USER rtorrent
		echo "$USER - rtorrent został zatrzymany"
	fi
}

restartRt() {
	stopRt
	sleep 2s
	startRt
}

statusRt() {
	checkUser
	if [ $ISSTARTED = '0' ] ; then
		echo "(0) $USER"
	else
		echo "(1) $USER"
	fi
}

if [ $USER = "all" ] ; then
	if [ $ACTION = "start" ] ; then
		for rtUsers in /var/rutorrent/rutorrent/conf/users/* ; do
			rtUsers=`echo $rtUsers | sed -e 's/\/var\/rutorrent\/rutorrent\/conf\/users\///g'`
			if [ `cat exclude | grep $rtUsers | wc -l` != 1 ] ; then
				/root/startrt start $rtUsers
			else
				echo "$rtUsers ma wyłączone konto"
			fi
		done
	elif [ $ACTION = "stop" ] ; then
		for rtUsers in /var/rutorrent/rutorrent/conf/users/* ; do
			rtUsers=`echo $rtUsers | sed -e 's/\/var\/rutorrent\/rutorrent\/conf\/users\///g'`
			/root/startrt stop $rtUsers
		done
	elif [ $ACTION = "restart" ] ; then
		for rtUsers in /var/rutorrent/rutorrent/conf/users/* ; do
			rtUsers=`echo $rtUsers | sed -e 's/\/var\/rutorrent\/rutorrent\/conf\/users\///g'`
			/root/startrt restart $rtUsers
		done
	elif [ $ACTION = "status" ] ; then
		for rtUsers in /var/rutorrent/rutorrent/conf/users/* ; do
			rtUsers=`echo $rtUsers | sed -e 's/\/var\/rutorrent\/rutorrent\/conf\/users\///g'`
			/root/startrt status $rtUsers
		done
	fi

elif [ $USER != "all" ] ; then
	if [ $ACTION = "start" ] ; then
		startRt
	elif [ $ACTION = "stop" ] ; then
		stopRt
	elif [ $ACTION = "restart" ] ; then
		restartRt
	elif [ $ACTION = "status" ] ; then
		statusRt
	fi
fi
